---
layout: post
title: "Флейки тест"
description: ""
category:
header-text: "TODO"
tags: []
---
{% include JB/setup %}

Привет!

Если интересно, я только что раскусил ещё один флейки тест, над которым я мучался года три.

Благодаря твоему видео, конечно. 

В общем, жил-был такой тест:

```java
    $(By.name("message.text")).sendKeys("My quick reply");
    $("#send-button").click();
```

он кликает на банковском сообщении "Reply", вбивает текст "My quick reply" и нажимает "Send". 
И проверяет, что попал на следующую страничку типа "сообщение отослано".

Но иногда он падал, потому что не попадал на следующую страничку, а продолжал висеть на форме сообщения.

Я уж и так и сяк. Думал, кнопка не успевает активизироваться. Понадобавлял всяких проверок:

```java
    $(By.name("message.text")).shouldBe(visible, enabled).sendKeys("My quick reply");
    $("#send-button").shouldBe(enabled).click();
```

А всё равно иногда грохается.

И вот наконец повесил `@Video` на тест, и сегодня сработало!

Вот видео: https://vimeo.com/175881629


Весь фокус на 4-5 секундах.

Оказывается, библиотека jquery mobile использует плагин `autogrow`, который автоматически увеличивает размер `<textarea>`, если в неё текст не влазит. 
И в данном случае этот плагин начал растягивать нашу `<textarea>` ПОСЛЕ того, как тест успел вбить туда свой текст, 
но КАК РАЗ в тот момент, когда тест пытался кликнуть кнопку `Send`. И тест промазывал мимо кнопки.

А лекарство простое. Оказалось, этот чёртов плагин, после того, как растянет `<textarea>`, добавляет ему CSS класс. 
Поэтому я просто добавил ожидание этого класса:

```java
    $(By.name("message.text"))
      .shouldHave(cssClass("ui-textinput-autogrow"))
      .sendKeys("My quick reply");
```


<br/>
<br/>

[Андрей Солнцев](http://asolntsev.github.io/)

ru.selenide.org
